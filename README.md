# 가정 전력 관리 IOT

머신러닝 기반 가전 전자기기 패턴 분석 및 소비 전력 예측, 가정 전력 관리 IOT

## INDEX

> ### Project desgin part
>
> **프로젝트 개요** <br>
>
> 1\) 프로젝트 소개
> 2\) 추진 배경 및 필요성
> 3\) 개발 목표 및 구성도
>
> **기대 효과 및 활용 분야**

<br>

> ### Internal technology part
>
> **Smart tap** <br>
> 1\) Sensor & parts
>
> **Energier** <br>
> 1\) Sensor & parts
>
> **Andorid application** <br>
> 1\) Menu & UI & 기능
>
> **Server**
> 1\) Development environment & technology
>
> **Machine learning**
>
> 1\) 전기 사용량 예측
> 2\) 전류 사용 패턴 분석

<br>

## Project desgin part

### 프로젝트 개요

#### 프로젝트 설명
머신러닝 기반으로 가정의 총 소비전력과 가전 제품의 개별 소비전력을 측정 및 분석 관리해주는 시스템 <br>

#### 기획의도
1. 누진세 방지
2. 대기전력 차단
3. 전기 사용량 예측 및 분석

<br>

#### 프로젝트 내용
본 프로젝트는 가정에서 사용되어지는 전력을 절약하기 위한 목표를 가지며, 크게 네 가지로 나누어 볼 수 있다.
1. 개별 전력 측정 기기인 스마트 멀티탭
2. 전체 전력 측정 기기이며  우리 제품은 Energier로 불림
3. Android application
4. 모니터링 서비스

<br>

#### 시스템 구성도
![구성도](/images/시스템구성도.png)<br>

#### 기능 구성도
![구성도](/images/개요_구성도.png)<br>

#### 하드웨어 구성도
##### Energier
![구성도](/images/하드웨어구성도_1.png)
![구성도](/images/하드웨어구성도_표_1.png)<br>

##### 스마트 멀티탭
![구성도](/images/하드웨어구성도_2.png)
![구성도](/images/하드웨어구성도_표_2.png)<br>

### 기대 효과 및 활용 분야
> **전기 수요 예측 및 패턴 분석 　→　 전기 요금 절약 및 화제 예방**
> **전자기기 패턴 분석 　→　 개별적으로 많이 사용하는 제품 인지**
> **Smart home infra 　→　 수요관리사업자로서 수요자원거래시장 참여**

<br>

## Internal technology part

### Smart tap
Smart tap은 소위 스마트 멀티탭이라 불리는 기기다. 본 프로젝트에서는 가정에서 사용되어지는 개별 전력들을 측정하기위한 기기다.<br><br>

#### Sensor & parts
##### Raspberry Pi 3 B+

![Raspberry Pi](/images/Raspberry.png)<br>

##### ASC 712
전류를 측정하기 위한 센서로, 출력이 아날로그 값이기 때문에 ADC(Analog-to-Digital Converter)를 이용하여 값을 구했다.

 ![acs 712](/images/acs-712.png)![연결 방법](/images/acs-712-연결방법.png)<br>


 ***ⅰ)*** 계산은 True RMS 전류를 구하는 방식인 `제곱 평균 제곱근을` 이용했다.

 ***ⅱ)*** 전류 측정은 콘센트가 연결된 순간부터 계속 진행되어야 하기에 1초마다 1구씩, 총 4개의 구를 돌아가면서 전류를 측정한다.


##### Relay module
 릴레이 모듈을 이용하여 스마트 멀티탭을 원격제어 할 수 있게 된다. 사용법은 NO 단자와 NC 단자 중 어디에 전선을 연결하는지에 따라 프로세서가 주는 신호 중 HIGH에 켜지거나 LOW에 켜지는 것을 결정할 수 있다.

 ![릴레이 모듈](/images/릴레이모듈.png)<br>

안드로이드 어플로부터 원격 제어 신호가 들어오면 그 신호에 따라서 릴레이 모듈이 전원 ON/OFF를 제어하게 된다.<br>


##### Push button
 Push button은 스마트 멀티탭을 처음 이용시에 wifi 설정에 사용되어진다.
<br>

##### LCD
 LCD는 스마트 멀티탭에서 wifi 연결 여부, 현재 사용중인 전력값 등 간단한 정보를 표시하기 위함이다.
<br>

##### ADC Converter
 전류 측정을 할 때 라즈베리파이를 이용해 ACS-712에서 값을 추출하는데, 이 때 아날로그 신호를 디지털 신호로 변경하기 위해 사용한다.
<br>

#### 배치도
![멀티탭 배치도](/images/멀티탭_배치도.png)<br>
- 각 모듈들과 라즈베리파이에 전원을 공급하기 위한 변압기를 추가시킨다.
- 메인이 되는 선의 (+)를 릴레이 모듈로 먼저 들어가게 한다. 이는 릴레이 모듈이 열렸는데도 스위치에서는 닫힘 판정을 받는 것을 방지하기 위함이다.
- 릴레이 모듈을 통과한 (+)선은 스위치를 거쳐서 멀티탭 구에 들어간다.
- 메인이 되는 선의 (-)는 스위치로 먼저 들어가게 한다. 스위치를 통과한 (-)는 ACS-712로 들어가서 전류 측정에 사용된다.
- 각 구는 GND 단자와 연결한다.
<br>

### Energier (전체 전력 측정 기기)
Energier는 가정 내에서 사용되어지는 전체 전력을 측정하기 위한 기기<br>

#### Sensor & parts
##### Arduino nano & Nodemcu

![arduino nano](/images/nano.png) ![nodemcu](/images/Nodemcu.png)<br>

##### SCT-013-000
전류 센서인 SCT-013-000은 EmonLib를 사용하여 설계를 진행했으며 설계 방법은 아래와 같다.<br>

![CT](/images/CT.png)

CT센서를 통해 전류를 측정하기 위해서는 Burden 저항값과 계산값이 필요하다. 아래 세가지 식을 이용해서 이상적인 burden 저항값을 구할 수 있다.<br>

> Primary peak-current = RMS current × √2 = 100 A × 1.414 = 141.4A
> Secondary peak-current = Primary peak-current / no. of turns = 141.4 A / 2000 = 0.0707A
> Ideal burden resistance = (AREF/2) / Secondary peak-current = 2.5 V / 0.0707 A = 35.4 Ω

<br>

이상적인 Burden저항의 값은 35.4 Ω이지만 해당값을 구하기 위해서는 저항을 합성하는 과정이 필요하고, 본 설계에서는 3가지 저항을 합성해 36 Ω을 제작하여 사용했다.


##### ZMPT101B
전압 센서로, 전압측정은 유효 전력을 구하기 위한 순시전압을 얻을 때 사용한다. 구해진 순시전압은 순시전류와 곱해서 유효전력이라 부른다.

![ZMPT101B](/images/ZMPT101B.png)<br>

#### 회로 구성

![회로구성](/images/회로구성.png)<br>

#### 전체 구성도

![전체회로구성도](/images/전체회로구성도.png)

케이스에는 하나의 출입구가 있어 전류와 전압을 측정하기 위한 각각의 케이블이 같은 출입구를 사용한다. 또한 모듈은 아두이노를 사용하며 통신을위한 nodemcu가 추가적으로 사용된다.
<br>

### Andorid application

#### Menu & UI & 기능
##### 초기 화면 메뉴
![초기화면메뉴](/images/초기화면메뉴.png)<br>

##### 이용량 조회
![이용량조회](/images/이용량조회.png)<br>

##### 원격 제어
![원격제어](/images/원격제어.png)<br>

##### 전력 예측
![전력예측](/images/전력예측.png)<br>

##### 기기 연결
![기기 연결](/images/기기연결.png)<br>
<br>

### Server
#### AWS - EC2
Amazon Web Service EC2를 서버로 활용하고 있다. 다음 표는 서버에서 수행중인 내용이다.<br>
 ![서버 표](/images/서버_표.png)<br>

### Machine learning
#### 전기 사용량 예측
- Random Forest Regression 기반의 머신러닝
- 훈련 과정에서 구성한 다수의 결정 트리로부터 분류 또는 평균 예측치를 출력함으로써 동작
- 결정트리는 계층구조로 이루어진 노드들과 에지들의 집합으로 이루어져있으며 여러 개의 의사결정트리를 만들고, 투표를 시켜 다수결로 결과를 결정<br>
![알고리즘 변수의 중요도](/images/알고리즘_변수의_중요도.png)<br>

머신러닝을 통해 사용량 예측을 수행할 때 **위 그림의 데이터셋에서 각 변수의 중요도를 확인**하며 **시간, 기온과 같은 항목들에 대해서 각 관련성마다 예측을 차등**하게 수행한다.<br>

![분석결과](/images/분석결과.png)<br>

**빨간색 실선**으로 표시되어있는 부분이 2013년의 전류 사용 데이터로 트레이닝하여 2014년의 독립 변수들에 대입시킨 **전기 예측 사용량**이고, **파란색 실선**으로 이어진 것이 **실제 2014년 전력 사용량**이다.
<br>

#### 전류 사용 패턴 분석
전류 사용 패턴을 분석함으로서 사용중인 기기를 식별할 수 있도록 하는 서비스다. 이는 두가지 과정을 거쳐서 판별하게 된다.<br>

![전자 제품 판별 과정](/images/전자제품판별과정.png)<br>

- 전류 사용 패턴을 통해 전자제품을 판별하는 과정
- 1차 판별로 클러스터링 과정을 통해 제품군을 분류
- 2차 판별은 분류된 제품군을 DTW(Dynamic Time Warping) 과정을 통해 유사도를 판별하여 최종적으로 전자제품을 판별<br>

<br>

